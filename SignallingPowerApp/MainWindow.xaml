<Window x:Class="SignallingPowerApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SignallingPowerApp"
        xmlns:vm="clr-namespace:SignallingPowerApp.ViewModels"
        mc:Ignorable="d"
        Title="Signalling Power App" Height="600" Width="1000"
        WindowState="Maximized"
        Closing="MainWindow_Closing">
    <Window.Resources>
        <!-- TreeView Hierarchical Template -->
        <HierarchicalDataTemplate DataType="{x:Type vm:TreeNodeViewModel}" ItemsSource="{Binding Children}">
            <TextBlock Text="{Binding Header}" />
        </HierarchicalDataTemplate>
        
        <!-- TabItem Header Template with Close Button -->
        <Style x:Key="ClosableTabItemStyle" TargetType="TabItem">
            <Setter Property="HeaderTemplate">
                <Setter.Value>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="{Binding}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <Button Content="✕" 
                                    Width="16" 
                                    Height="16" 
                                    FontSize="10"
                                    Padding="0"
                                    Margin="0"
                                    VerticalAlignment="Center"
                                    ToolTip="Close"
                                    Click="CloseTabButton_Click"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground" Value="Black"/>
                                                <Setter Property="Background" Value="#FFE0E0E0"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </DataTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    
    <DockPanel>
        <!-- Menu Bar -->
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_New" Click="NewMenuItem_Click"/>
                <MenuItem Header="_Open" Click="OpenMenuItem_Click"/>
                <MenuItem Header="_Save" Click="SaveMenuItem_Click"/>
                <MenuItem Header="Save _As..." Click="SaveAsMenuItem_Click"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="ExitMenuItem_Click"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Documentation"/>
                <MenuItem Header="_About" Click="AboutMenuItem_Click"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <ToolBarTray DockPanel.Dock="Top" IsLocked="True">
            <ToolBar HorizontalAlignment="Stretch">
                <Button x:Name="AddButton" ToolTip="Add blocks to canvas" Click="AddButton_Click">
                    
                    <Button.ContextMenu>
                        <ContextMenu x:Name="AddContextMenu">
                            <MenuItem Header="Location" Click="AddLocationMenuItem_Click"/>
                            <MenuItem Header="Supply" Click="AddSupplyMenuItem_Click"/>
                        </ContextMenu>
                    </Button.ContextMenu>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock x:Name="AddButtonText" Text="Add Block" VerticalAlignment="Center"/>
                        <TextBlock Text=" ▼" VerticalAlignment="Center" FontSize="8" Margin="3,0,0,0"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button x:Name="AddConnectionButton" Content="Edit Connections" ToolTip="Add Connection" Click="AddConnectionButton_Click"/>
                <Button x:Name="RemoveConnectionButton" Content="Remove Connections" ToolTip="Remove Connection" Click="RemoveConnectionButton_Click"/>
                <Separator/>
                <Button Content="Zoom In" ToolTip="Zoom In" Click="ZoomInButton_Click"/>
                <Button Content="Zoom Out" ToolTip="Zoom Out" Click="ZoomOutButton_Click"/>
                <Button Content="Fit" ToolTip="Fit All Blocks" Click="FitButton_Click"/>
            </ToolBar>
        </ToolBarTray>
        
        


        <!-- Main Content Area with GridSplitters -->
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="2*" MinHeight="200"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="1*" MinHeight="150"/>
            </Grid.RowDefinitions>

            <!-- Top Section: Tree View + Canvas -->
            <Grid Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200" MinWidth="150"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Tree View Section -->
                <Border Grid.Column="0" BorderBrush="Gray" BorderThickness="0,0,1,0">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top" 
                                   Text="Project Structure" 
                                   FontWeight="Bold" 
                                   Padding="5"
                                   Background="#FFE0E0E0"/>
                        <TreeView x:Name="ProjectTreeView" 
                                  Padding="5"
                                  ItemsSource="{Binding TreeViewItems}"
                                  SelectedItemChanged="ProjectTreeView_SelectedItemChanged">
                            <TreeView.ItemContainerStyle>
                                <Style TargetType="TreeViewItem">
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                                </Style>
                            </TreeView.ItemContainerStyle>
                        </TreeView>
                    </DockPanel>
                </Border>

                <!-- Vertical Splitter -->
                <GridSplitter Grid.Column="1" 
                              Width="3" 
                              HorizontalAlignment="Stretch" 
                              VerticalAlignment="Stretch"
                              Background="Gray"/>

                <!-- Canvas/Diagram Area -->
                <Border Grid.Column="2" BorderBrush="Gray" BorderThickness="0,0,0,0">
                    <TabControl x:Name="CanvasTabs" SelectionChanged="CanvasTabs_SelectionChanged">
                        <TabItem Header="Layout">
                            <Grid x:Name="CanvasContainer" 
                                  Background="White"
                                  ClipToBounds="True"
                                  MouseLeftButtonDown="CanvasContainer_MouseLeftButtonDown"
                                  MouseLeftButtonUp="CanvasContainer_MouseLeftButtonUp"
                                  MouseMove="CanvasContainer_MouseMove"
                                  MouseWheel="CanvasContainer_MouseWheel">
                                <Canvas x:Name="DiagramCanvas" 
                                        Width="2000" 
                                        Height="1500">
                                    <Canvas.Background>
                                        <DrawingBrush TileMode="Tile" Viewport="0,0,60,60" ViewportUnits="Absolute">
                                            <DrawingBrush.Drawing>
                                                <DrawingGroup>
                                                    <GeometryDrawing Brush="White">
                                                        <GeometryDrawing.Geometry>
                                                            <RectangleGeometry Rect="0,0,60,60"/>
                                                        </GeometryDrawing.Geometry>
                                                    </GeometryDrawing>
                                                    <GeometryDrawing>
                                                        <GeometryDrawing.Geometry>
                                                            <GeometryGroup>
                                                                <LineGeometry StartPoint="0,0" EndPoint="60,0"/>
                                                                <LineGeometry StartPoint="0,0" EndPoint="0,60"/>
                                                            </GeometryGroup>
                                                        </GeometryDrawing.Geometry>
                                                        <GeometryDrawing.Pen>
                                                            <Pen Brush="#FFE8E8E8" Thickness="1"/>
                                                        </GeometryDrawing.Pen>
                                                    </GeometryDrawing>
                                                </DrawingGroup>
                                            </DrawingBrush.Drawing>
                                        </DrawingBrush>
                                    </Canvas.Background>
                                    <Canvas.RenderTransform>
                                        <TransformGroup>
                                            <ScaleTransform x:Name="CanvasScaleTransform"/>
                                            <TranslateTransform x:Name="CanvasTranslateTransform"/>
                                        </TransformGroup>
                                    </Canvas.RenderTransform>
                                    <!-- Placeholder for diagram elements -->
                                    <TextBlock Canvas.Left="400" 
                                               Canvas.Top="200" 
                                               Text="Diagram Canvas Area - Click and drag to pan, mouse wheel to zoom" 
                                               FontSize="16" 
                                               Foreground="LightGray"/>
                                </Canvas>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </Border>
            </Grid>

            <!-- Horizontal Splitter -->
            <GridSplitter Grid.Row="1" 
                          Height="3" 
                          HorizontalAlignment="Stretch" 
                          VerticalAlignment="Stretch"
                          Background="Gray"/>

            <!-- Bottom Section: Data View -->
            <Border Grid.Row="2" BorderBrush="Gray" BorderThickness="0,1,0,0">
                <DockPanel>
                    <!-- Data Grid/Content Area -->
                    <TabControl x:Name="DataViewTabs">
                        <TabItem Header="Properties">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="PropertiesPanel" Margin="10">
                                    <!-- Properties will be populated dynamically -->
                                    <TextBlock Text="Select an item to view and edit its properties" 
                                               FontStyle="Italic" 
                                               Foreground="Gray"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Margin="20"/>
                                </StackPanel>
                            </ScrollViewer>
                        </TabItem>
                        <TabItem Header="Version Control">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="VersionControlPanel" Margin="15">
                                    <!-- Version Control content will be populated here -->
                                    <TextBlock Text="No project loaded" 
                                               x:Name="VersionControlPlaceholder"
                                               FontStyle="Italic" 
                                               Foreground="Gray"
                                               HorizontalAlignment="Center"
                                               VerticalAlignment="Center"
                                               Margin="20"/>
                                </StackPanel>
                            </ScrollViewer>
                        </TabItem>
                        <TabItem Header="Calculations">
                            <DockPanel Margin="5">
                                <!-- Top Section: Button to build paths -->
                                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,10" Orientation="Horizontal">
                                    <Button x:Name="BuildPathsButton"
                                            Content="Build Sequential Paths"
                                            Width="150"
                                            Height="30"
                                            HorizontalAlignment="Left"
                                            Margin="0,0,10,0"
                                            Click="BuildPathsButton_Click"/>
                                    <Button x:Name="PrintPathsButton"
                                            Content="Print"
                                            Width="80"
                                            Height="30"
                                            HorizontalAlignment="Left"
                                            Visibility="Collapsed"
                                            Click="PrintPathsButton_Click"/>
                                </StackPanel>
                                
                                <!-- Scrollable area to display paths -->
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <StackPanel x:Name="PathsDisplayPanel" Margin="5">
                                        <TextBlock Text="Click 'Build Sequential Paths' to generate and display connection paths"
                                                   FontStyle="Italic"
                                                   Foreground="Gray"
                                                   Margin="10"/>
                                    </StackPanel>
                                </ScrollViewer>
                            </DockPanel>
                        </TabItem>
                        <TabItem Header="Equipment">
                            <DockPanel>
                                <!-- Toolbar with Search -->
                                <Border DockPanel.Dock="Top" 
                                        Background="#FFF5F5" 
                                        BorderBrush="Gray" 
                                        BorderThickness="0,0,0,1"
                                        Padding="5">
                                    <DockPanel>
                                        <StackPanel DockPanel.Dock="Left" 
                                                    Orientation="Horizontal">
                                            <Button Content="Add Item"
                                                    Width="80"
                                                    Height="25"
                                                    Margin="0,0,5,0"
                                                    Click="AddEquipmentButton_Click"/>
                                            <Button Content="Export Items"
                                                    Width="90"
                                                    Height="25"
                                                    Margin="0,0,10,0"
                                                    Click="ExportEquipmentButton_Click"/>
                                        </StackPanel>
                                        <TextBlock DockPanel.Dock="Left" 
                                                   Text="Search:" 
                                                   VerticalAlignment="Center"
                                                   Margin="5,0,10,0"
                                                   FontWeight="SemiBold"/>
                                        <Button DockPanel.Dock="Right"
                                                Content="Clear"
                                                Width="60"
                                                Height="25"
                                                Margin="5,0,0,0"
                                                Click="ClearSearchButton_Click"/>
                                        <TextBox x:Name="EquipmentSearchBox"
                                                 Height="25"
                                                 Padding="5,2"
                                                 VerticalContentAlignment="Center"
                                                 TextChanged="EquipmentSearchBox_TextChanged"/>
                                    </DockPanel>
                                </Border>
                                
                                <!-- Equipment Tables -->
                                <ScrollViewer x:Name="EquipmentScrollViewer" 
                                              VerticalScrollBarVisibility="Auto">
                                    <StackPanel Margin="5">
                                        <!-- Conductors Section -->
                                        <TextBlock Text="Conductors" 
                                                   FontWeight="Bold" 
                                                   FontSize="14" 
                                                   Margin="0,0,0,5"/>
                                        <DataGrid x:Name="ConductorsGrid" 
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  CanUserDeleteRows="True"
                                                  IsReadOnly="True"
                                                  MaxHeight="200"
                                                  Margin="0,0,0,15"
                                                  PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Header="Edit" Width="50">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <Button Content="Edit" 
                                                                    Click="EditConductorButton_Click"
                                                                    Padding="5,2"
                                                                    IsEnabled="{Binding IsCustom}"/>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn Header="Custom" Binding="{Binding IsCustomText}" IsReadOnly="True" Width="60"/>
                                                <DataGridTextColumn Header="Cores" Binding="{Binding Cores}" Width="60"/>
                                                <DataGridTextColumn Header="Strand Count" Binding="{Binding StrandCount}" Width="90"/>
                                                <DataGridTextColumn Header="Strand Ø (mm)" Binding="{Binding StrandDiameter}" Width="100"/>
                                                <DataGridTextColumn Header="CSA (mm²)" Binding="{Binding CrossSectionalArea}" Width="90"/>
                                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="200"/>
                                                <DataGridTextColumn Header="V.Drop 60°C" Binding="{Binding VoltageDrop60}" Width="90"/>
                                                <DataGridTextColumn Header="V.Drop 90°C" Binding="{Binding VoltageDrop90}" Width="90"/>
                                                <DataGridTextColumn Header="Reactance" Binding="{Binding Reactance}" Width="80"/>
                                                <DataGridTextColumn Header="R 60°C" Binding="{Binding Resistance60}" Width="80"/>
                                                <DataGridTextColumn Header="R 90°C" Binding="{Binding Resistance90}" Width="80"/>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                        
                                        <!-- Transformers Section -->
                                        <TextBlock Text="Transformers/UPS" 
                                                   FontWeight="Bold" 
                                                   FontSize="14" 
                                                   Margin="0,0,0,5"/>
                                        <DataGrid x:Name="TransformersGrid" 
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  CanUserDeleteRows="True"
                                                  IsReadOnly="True"
                                                  MaxHeight="200"
                                                  Margin="0,0,0,15"
                                                  PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Header="Edit" Width="50">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <Button Content="Edit" 
                                                                    Click="EditTransformerButton_Click"
                                                                    Padding="5,2"
                                                                    IsEnabled="{Binding IsCustom}"/>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn Header="Custom" Binding="{Binding IsCustomText}" IsReadOnly="True" Width="60"/>
                                                <DataGridTextColumn Header="Rating (kVA)" Binding="{Binding Rating}" Width="100"/>
                                                <DataGridTextColumn Header="% Z" Binding="{Binding PercentageZ}" Width="80"/>
                                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*"/>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                        
                                        <!-- Alternators Section -->
                                        <TextBlock Text="Alternators" 
                                                   FontWeight="Bold" 
                                                   FontSize="14" 
                                                   Margin="0,0,0,5"/>
                                        <DataGrid x:Name="AlternatorsGrid" 
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  CanUserDeleteRows="True"
                                                  IsReadOnly="True"
                                                  MaxHeight="200"
                                                  Margin="0,0,0,15"
                                                  PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Header="Edit" Width="50">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <Button Content="Edit" 
                                                                    Click="EditAlternatorButton_Click"
                                                                    Padding="5,2"
                                                                    IsEnabled="{Binding IsCustom}"/>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn Header="Custom" Binding="{Binding IsCustomText}" IsReadOnly="True" Width="60"/>
                                                <DataGridTextColumn Header="Rating VA" Binding="{Binding RatingVA}" Width="100"/>
                                                <DataGridTextColumn Header="Rating W" Binding="{Binding RatingW}" Width="100"/>
                                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*"/>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                        
                                        <!-- Consumers Section -->
                                        <TextBlock Text="Consumers" 
                                                   FontWeight="Bold" 
                                                   FontSize="14" 
                                                   Margin="0,0,0,5"/>
                                        <DataGrid x:Name="ConsumersGrid" 
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  CanUserDeleteRows="True"
                                                  IsReadOnly="True"
                                                  MaxHeight="200"
                                                  Margin="0,0,0,15"
                                                  PreviewMouseWheel="DataGrid_PreviewMouseWheel">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Header="Edit" Width="50">
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <Button Content="Edit" 
                                                                    Click="EditConsumerButton_Click"
                                                                    Padding="5,2"
                                                                    IsEnabled="{Binding IsCustom}"/>
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>
                                                <DataGridTextColumn Header="Custom" Binding="{Binding IsCustomText}" IsReadOnly="True" Width="60"/>
                                                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="150"/>
                                                <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*"/>
                                                <DataGridTextColumn Header="Load (VA)" Binding="{Binding Load}" Width="100"/>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                    </StackPanel>
                                </ScrollViewer>
                            </DockPanel>
                        </TabItem>
                    </TabControl>
                </DockPanel>
            </Border>
        </Grid>
    </DockPanel>
</Window>
